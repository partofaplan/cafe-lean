<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Lean Coffee Admin</title>
    <style>
      :root { --bg: #0b1020; --panel: #0f1630; --line: #23305f; --text: #f2f5ff; --muted:#a3b0d4; --accent: #34d399; --danger:#ef4444; --primary:#60a5fa; }
      html, body { height: 100%; }
      body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--text); }
      .wrap { display: flex; flex-direction: column; height: 100%; }
      header { padding: 12px 16px; border-bottom: 1px solid var(--line); display:flex; align-items:center; gap: 12px; justify-content:space-between; }
      header .title { font-weight: 600; }
      .cols { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 12px; flex: 1; }
      .col { background: var(--panel); border: 1px solid var(--line); border-radius: 12px; display:flex; flex-direction:column; }
      .col h2 { font-size: 18px; margin: 12px; color: var(--muted); display:flex; justify-content:space-between; align-items:center; }
      .list { padding: 0 12px 12px; overflow-y:auto; min-height: 100px; }
      .card { background: #111a3b; border:1px solid #2b3a79; border-radius:10px; padding:10px 12px; margin: 10px 0; display:flex; justify-content:space-between; gap: 10px; align-items:center; }
      .card .left { display:flex; flex-direction:column; gap:6px; }
      .votes { color: var(--primary); font-weight: 600; }
      .btn { font-size: 14px; padding: 6px 10px; border-radius: 8px; border:1px solid #3759a3; background:#13204a; color:#fff; cursor:pointer; }
      .btn.primary { background: #2563eb; border-color: #2563eb; }
      .btn.danger { background: #7f1d1d; border-color: #ef4444; }
      .btnbar { display:flex; gap: 6px; flex-wrap: wrap; }
      .row { display:flex; gap: 8px; align-items:center; }
      input[type="text"] { font-size: 16px; padding: 8px 10px; border-radius: 8px; border: 1px solid #33407a; background: #0f1630; color: #fff; }
      .muted { color: var(--muted); font-size: 14px; }
      @media (max-width: 900px){ .cols { grid-template-columns: 1fr; } }
    </style>
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div class="title">Admin — <span id="code"></span></div>
        <div class="row">
          <input id="token" type="text" placeholder="Admin token" />
          <button id="saveToken" class="btn">Save</button>
          <button id="helpBtn" class="btn" title="Lean Coffee rules">?</button>
        </div>
      </header>
      <div id="phasePrompt" style="display:none; padding:12px; border-bottom:1px solid var(--line); background:#0f1630;">
        <div id="promptText" style="margin-bottom:8px; font-weight:600;"></div>
        <div class="row">
          <button id="promptAddMinResume" class="btn">+1 min & Resume</button>
          <button id="promptAdvance" class="btn primary">Advance</button>
          <button id="promptDismiss" class="btn">Dismiss</button>
        </div>
      </div>
      <div style="padding:12px; border-bottom:1px solid var(--line); display:flex; gap:16px; flex-wrap:wrap; align-items:center;">
        <div>
          <div class="muted">Current Phase</div>
          <div id="phaseLabel" style="font-weight:600;">—</div>
          <div class="muted">Time remaining: <span id="phaseTime">—</span></div>
        </div>
        <div class="row">
          <button id="adjustTimers" class="btn">Adjust timers</button>
          <button id="startCreate" class="btn">Start Create</button>
          <button id="startVote" class="btn">Start Voting</button>
          <button id="pausePhase" class="btn">Pause</button>
          <button id="resumePhase" class="btn">Resume</button>
          <button id="addMin" class="btn">+1 min</button>
          <button id="endPhase" class="btn">End Phase</button>
        </div>
      </div>
      <div class="cols">
        <div class="col"><h2>To Discuss</h2><div id="todo" class="list"></div></div>
        <div class="col"><h2>Discussing</h2><div id="doing" class="list"></div></div>
        <div class="col"><h2>Done</h2><div id="done" class="list"></div></div>
      </div>
      <div style="padding:12px; border-top:1px solid var(--line);" class="muted">
        <div>Only admins can move/delete topics. Save the admin token provided when creating the meeting.</div>
        <div style="margin-top:8px;">
          Share this link with participants:
          <div class="row" style="margin-top:6px;">
            <input id="shareLink" type="text" readonly style="flex:1;" />
            <button id="copyLink" class="btn">Copy</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const meetingId = location.pathname.split('/').pop().toUpperCase();
      document.getElementById('code').textContent = meetingId;
      const socket = io();
      const tokenInput = document.getElementById('token');
      const saved = localStorage.getItem(`adminToken:${meetingId}`);
      if (saved) tokenInput.value = saved;
      document.getElementById('saveToken').onclick = () => {
        localStorage.setItem(`adminToken:${meetingId}`, tokenInput.value.trim());
        alert('Saved admin token for this device.');
      };

      socket.emit('join', { meetingId, role: 'admin', adminToken: tokenInput.value.trim() || null });

      // Share link setup
      const shareLinkEl = document.getElementById('shareLink');
      const shareUrl = `${location.origin}/join/${meetingId}`;
      shareLinkEl.value = shareUrl;
      document.getElementById('copyLink').onclick = async () => {
        try { await navigator.clipboard.writeText(shareUrl); alert('Link copied'); }
        catch { shareLinkEl.select(); document.execCommand('copy'); alert('Link copied'); }
      };

      const cols = { todo: document.getElementById('todo'), doing: document.getElementById('doing'), done: document.getElementById('done') };
      function el({ tag='div', text, className }){ const e = document.createElement(tag); if(text) e.textContent=text; if(className) e.className=className; return e; }
      function move(topicId, column){ const adminToken = tokenInput.value.trim(); socket.emit('move_topic', { meetingId, topicId, column, adminToken }); }
      function startDiscuss(topicId){ const adminToken = tokenInput.value.trim(); const mins = (durations && durations.discuss) ? Number(durations.discuss) : undefined; socket.emit('start_phase', { meetingId, adminToken, phase:'discuss', topicId, minutes: mins }); }
      function del(topicId){ const adminToken = tokenInput.value.trim(); if(!confirm('Delete topic?')) return; socket.emit('delete_topic', { meetingId, topicId, adminToken }); }

      // Phase controls
      const phaseLabel = document.getElementById('phaseLabel');
      const phaseTime = document.getElementById('phaseTime');
      let durations = { create: 5, voting: 3, discuss: 5 };
      // Adjust timers modal
      const adjustBtn = document.getElementById('adjustTimers');
      adjustBtn.onclick = () => { openTimersModal(); };
      document.getElementById('startCreate').onclick = () => {
        const adminToken = tokenInput.value.trim(); const mins = durations && durations.create ? Number(durations.create) : undefined;
        socket.emit('start_phase', { meetingId, adminToken, phase:'create', minutes: mins });
      };
      document.getElementById('startVote').onclick = () => {
        const adminToken = tokenInput.value.trim(); const mins = durations && durations.voting ? Number(durations.voting) : undefined;
        socket.emit('start_phase', { meetingId, adminToken, phase:'voting', minutes: mins });
      };
      document.getElementById('addMin').onclick = () => {
        const adminToken = tokenInput.value.trim(); socket.emit('add_minute', { meetingId, adminToken });
      };
      document.getElementById('endPhase').onclick = () => {
        const adminToken = tokenInput.value.trim(); socket.emit('end_phase', { meetingId, adminToken });
      };
      document.getElementById('pausePhase').onclick = () => {
        const adminToken = tokenInput.value.trim(); socket.emit('pause_phase', { meetingId, adminToken });
      };
      document.getElementById('resumePhase').onclick = () => {
        const adminToken = tokenInput.value.trim(); socket.emit('resume_phase', { meetingId, adminToken });
      };

      let phaseTicker = null; let lastNow = 0; let endsAt = 0; let currentPhase = null; let currentTopicId = null; let topicsIdx = new Map(); let paused = false; let remainingMs = 0;
      function updatePhaseUI(){
        if (!currentPhase){ phaseLabel.textContent = '—'; phaseTime.textContent = '—'; return; }
        let label = currentPhase;
        if (currentPhase === 'discuss' && currentTopicId && topicsIdx.get(currentTopicId)){
          label = `Discussing: ${topicsIdx.get(currentTopicId).title}`;
        } else if (currentPhase === 'create') label = 'Creating topics';
        else if (currentPhase === 'voting') label = 'Voting';
        if (paused) label += ' (Paused)';
        phaseLabel.textContent = label;
        const now = Date.now();
        const base = paused ? Math.max(0, Math.floor((remainingMs)/1000)) : Math.max(0, Math.floor((endsAt - now)/1000));
        const rem = base;
        const m = Math.floor(rem/60), s = rem%60;
        phaseTime.textContent = `${m}:${String(s).padStart(2,'0')}`;
      }
      function startTicker(){ if (phaseTicker) clearInterval(phaseTicker); phaseTicker = setInterval(updatePhaseUI, 500); }

      // Phase expired prompt
      const phasePrompt = document.getElementById('phasePrompt');
      const promptText = document.getElementById('promptText');
      const promptAddMinResume = document.getElementById('promptAddMinResume');
      const promptAdvance = document.getElementById('promptAdvance');
      const promptDismiss = document.getElementById('promptDismiss');
      function hidePrompt(){ phasePrompt.style.display = 'none'; }
      function showPrompt(text){ promptText.textContent = text; phasePrompt.style.display = 'block'; }
      promptDismiss.onclick = hidePrompt;
      promptAddMinResume.onclick = () => { const adminToken = tokenInput.value.trim(); socket.emit('add_minute', { meetingId, adminToken }); socket.emit('resume_phase', { meetingId, adminToken }); hidePrompt(); };
      promptAdvance.onclick = () => {
        const adminToken = tokenInput.value.trim();
        if (currentPhase === 'create') { socket.emit('start_phase', { meetingId, adminToken, phase:'voting' }); }
        else if (currentPhase === 'voting') { alert('Move a topic to Discussing and click Start Timer when ready.'); }
        else if (currentPhase === 'discuss') {
          if (currentTopicId) { socket.emit('move_topic', { meetingId, topicId: currentTopicId, column:'done', adminToken }); }
          socket.emit('end_phase', { meetingId, adminToken });
        }
        hidePrompt();
      };

      socket.on('state', (state) => {
        // Durations
        if (state.durations){ durations = state.durations; preloadTimersModal(durations); }
        // Phase
        currentPhase = state.phase || null; endsAt = state.phaseEndsAt || 0; lastNow = state.now || Date.now(); currentTopicId = state.currentTopicId || null; paused = !!state.phasePaused; remainingMs = state.phaseRemainingMs || 0;
        updatePhaseUI(); startTicker();
        if (!currentPhase || (!paused && endsAt && endsAt > Date.now())) hidePrompt();
        for (const k of Object.keys(cols)) cols[k].innerHTML = '';
        const byCol = { todo: [], doing: [], done: [] };
        topicsIdx = new Map();
        for (const t of state.topics){ byCol[t.column||'todo'].push(t); topicsIdx.set(t.id, t); }
        const sort = arr => arr.sort((a,b)=> b.votes - a.votes || a.createdAt - b.createdAt);
        for (const col of ['todo','doing','done']){
          for (const t of sort(byCol[col])){
            const c = el({ className: 'card' });
            const left = el({ className:'left' });
            left.appendChild(el({ text: t.title }));
            left.appendChild(el({ className:'votes', text: `▲ ${t.votes || 0}` }));
            const bar = el({ className:'btnbar' });
            if (t.column !== 'todo') bar.appendChild(Object.assign(el({ tag:'button', className:'btn' , text:'To Discuss'}), { onclick: () => move(t.id, 'todo') }));
            if (t.column !== 'doing') bar.appendChild(Object.assign(el({ tag:'button', className:'btn' , text:'Discussing'}), { onclick: () => move(t.id, 'doing') }));
            if (t.column !== 'done') bar.appendChild(Object.assign(el({ tag:'button', className:'btn' , text:'Done'}), { onclick: () => move(t.id, 'done') }));
            if (t.column === 'doing') bar.appendChild(Object.assign(el({ tag:'button', className:'btn primary', text:'Start Timer'}), { onclick: () => startDiscuss(t.id) }));
            bar.appendChild(Object.assign(el({ tag:'button', className:'btn danger', text:'Delete'}), { onclick: () => del(t.id) }));
            c.appendChild(left); c.appendChild(bar);
            cols[col].appendChild(c);
          }
        }
      });

      // Server signals when a phase timer expires
      socket.on('phase_expired', ({ phase }) => {
        if (phase === 'create') showPrompt('Create phase ended. Add 1 minute or go to Voting?');
        else if (phase === 'voting') showPrompt('Voting ended. Add 1 minute or pick a topic to discuss.');
        else if (phase === 'discuss') showPrompt('Discussion time ended. Add 1 minute or complete the topic and pick another.');
      });

      // ----- Timers modal -----
      const modalHtml = `
        <div id="timersOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:9999;">
          <div style="background:#0f1630;border:1px solid #23305f;border-radius:12px;max-width:520px;width:92%;padding:16px;">
            <h3 style="margin-top:0;margin-bottom:8px;">Adjust Phase Timers</h3>
            <div class="muted">Set timer lengths in minutes. Applies immediately.</div>
            <div class="row" style="margin-top:12px;">
              <label style="min-width:110px;">Create Topics</label>
              <input id="mDurCreate" type="number" min="1" max="60" style="width:100px;" />
            </div>
            <div class="row" style="margin-top:8px;">
              <label style="min-width:110px;">Voting</label>
              <input id="mDurVote" type="number" min="1" max="60" style="width:100px;" />
            </div>
            <div class="row" style="margin-top:8px;">
              <label style="min-width:110px;">Discuss</label>
              <input id="mDurDiscuss" type="number" min="1" max="60" style="width:100px;" />
            </div>
            <div class="row" style="margin-top:12px;justify-content:flex-end;">
              <button id="mCancel" class="btn">Cancel</button>
              <button id="mSave" class="btn primary">Save</button>
            </div>
          </div>
        </div>`;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      const overlay = document.getElementById('timersOverlay');
      function preloadTimersModal(d){
        const c=document.getElementById('mDurCreate'); const v=document.getElementById('mDurVote'); const s=document.getElementById('mDurDiscuss');
        if (c) c.value = d.create; if (v) v.value = d.voting; if (s) s.value = d.discuss;
      }
      function openTimersModal(){ overlay.style.display='flex'; preloadTimersModal(durations); }
      function closeTimersModal(){ overlay.style.display='none'; }
      overlay.addEventListener('click', (e)=>{ if(e.target===overlay) closeTimersModal(); });
      document.getElementById('mCancel').onclick = closeTimersModal;
      document.getElementById('mSave').onclick = () => {
        const adminToken = tokenInput.value.trim();
        const c = Number(document.getElementById('mDurCreate').value)||durations.create;
        const v = Number(document.getElementById('mDurVote').value)||durations.voting;
        const s = Number(document.getElementById('mDurDiscuss').value)||durations.discuss;
        socket.emit('set_durations', { meetingId, adminToken, create: c, voting: v, discuss: s });
        closeTimersModal();
      };

      // ----- Help modal -----
      const helpHtml = `
        <div id="helpOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:9999;">
          <div style="background:#0f1630;border:1px solid #23305f;border-radius:12px;max-width:640px;width:92%;padding:16px;">
            <h3 style="margin-top:0;margin-bottom:8px;">Lean Coffee — How it works</h3>
            <ul style="line-height:1.5; margin-left: 18px;">
              <li>Everyone proposes topics during the <strong>Create</strong> phase.</li>
              <li>Each participant gets <strong>3 votes</strong> to prioritize topics in the <strong>Voting</strong> phase.</li>
              <li>Discuss topics in order of votes. Each discussion is <strong>time‑boxed</strong>.</li>
              <li>At the end of a timer, choose to <strong>continue</strong> or <strong>move on</strong> to the next topic.</li>
              <li>Columns: <strong>To Discuss</strong>, <strong>Discussing</strong>, <strong>Done</strong>. Only admins move topics.</li>
            </ul>
            <div class="row" style="justify-content:flex-end; margin-top: 12px;">
              <button id="hClose" class="btn primary">Got it</button>
            </div>
          </div>
        </div>`;
      document.body.insertAdjacentHTML('beforeend', helpHtml);
      const helpOverlay = document.getElementById('helpOverlay');
      document.getElementById('helpBtn').onclick = () => { helpOverlay.style.display = 'flex'; };
      document.getElementById('hClose').onclick = () => { helpOverlay.style.display = 'none'; };
      helpOverlay.addEventListener('click', (e)=>{ if(e.target===helpOverlay) helpOverlay.style.display='none'; });
    </script>
  </body>
  </html>

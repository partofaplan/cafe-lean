<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Lean Coffee Admin</title>
    <style>
      :root { --bg: #0b1020; --panel: #0f1630; --line: #23305f; --text: #f2f5ff; --muted:#a3b0d4; --accent: #34d399; --danger:#ef4444; --primary:#60a5fa; }
      html, body { height: 100%; }
      body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--text); }
      .wrap { display: flex; flex-direction: column; height: 100%; }
      header { padding: 12px 16px; border-bottom: 1px solid var(--line); display:flex; align-items:center; gap: 12px; justify-content:space-between; }
      header .title { font-weight: 600; }
      .cols { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 12px; flex: 1; }
      .col { background: var(--panel); border: 1px solid var(--line); border-radius: 12px; display:flex; flex-direction:column; }
      .col h2 { font-size: 18px; margin: 12px; color: var(--muted); display:flex; justify-content:space-between; align-items:center; }
      .list { padding: 0 12px 12px; overflow-y:auto; min-height: 100px; }
      .list.drop-target { outline: 2px dashed var(--primary); outline-offset: -6px; }
      .card[draggable="true"] { cursor: grab; }
      .card[draggable="true"]:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }
      .card { background: #111a3b; border:1px solid #2b3a79; border-radius:10px; padding:10px 12px; margin: 10px 0; display:flex; justify-content:space-between; gap: 10px; align-items:center; }
      .card .left { display:flex; flex-direction:column; gap:6px; }
      .votes { color: var(--primary); font-weight: 600; }
      .btn { font-size: 14px; padding: 6px 10px; border-radius: 8px; border:1px solid #3759a3; background:#13204a; color:#fff; cursor:pointer; }
      .btn.primary { background: #2563eb; border-color: #2563eb; }
      .btn.danger { background: #7f1d1d; border-color: #ef4444; }
      .btnbar { display:flex; gap: 6px; flex-wrap: wrap; }
      .row { display:flex; gap: 8px; align-items:center; }
      input[type="text"] { font-size: 16px; padding: 8px 10px; border-radius: 8px; border: 1px solid #33407a; background: #0f1630; color: #fff; }
      .muted { color: var(--muted); font-size: 14px; }
      @media (max-width: 900px){ .cols { grid-template-columns: 1fr; } }
      .progress { position: relative; width: 240px; height: 8px; background: #0f1630; border:1px solid #23305f; border-radius: 999px; overflow: hidden; }
      .progress .bar { height: 100%; width: 0%; background: linear-gradient(90deg, #2563eb, #60a5fa); transition: width 0.3s ease; }
      .icon-btn { width: 36px; height: 36px; display:flex; align-items:center; justify-content:center; font-size:18px; border-radius: 8px; position:relative; }
      .icon-btn::after {
        content: attr(data-label);
        position:absolute;
        bottom:-34px;
        left:50%;
        transform:translateX(-50%);
        background:#111a3b;
        color:#f2f5ff;
        padding:4px 8px;
        border-radius:6px;
        font-size:12px;
        opacity:0;
        pointer-events:none;
        transition:opacity 0.2s ease, transform 0.2s ease;
        white-space:nowrap;
        border:1px solid rgba(255,255,255,0.1);
      }
      .icon-btn:hover::after, .icon-btn:focus-visible::after {
        opacity:1;
        transform:translate(-50%, -6px);
      }
    </style>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/ui.js"></script>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div class="title">Admin ‚Äî <span id="code"></span></div>
        <div class="row">
          <input id="token" type="text" placeholder="Admin token" />
          <button id="saveToken" class="btn">Save</button>
          <button id="helpBtn" class="btn" title="Lean Coffee rules">?</button>
        </div>
      </header>
      <div id="phasePrompt" style="display:none; padding:12px; border-bottom:1px solid var(--line); background:#0f1630;">
        <div id="promptText" style="margin-bottom:8px; font-weight:600;"></div>
        <div class="row">
          <button id="promptAddMinResume" class="btn">Continue (+1 min)</button>
          <button id="promptAdvance" class="btn primary">Advance</button>
          <button id="promptDismiss" class="btn">Dismiss</button>
        </div>
      </div>
      <div style="padding:12px 16px; border-bottom:1px solid var(--line); display:flex; gap:16px; flex-wrap:wrap; align-items:center;">
        <div>
          <div class="muted">Current Phase</div>
          <div id="phaseLabel" style="font-weight:600;">‚Äî</div>
          <div class="muted">Time remaining: <span id="phaseTime">‚Äî</span></div>
        </div>
        <div class="progress" title="Phase progress"><div id="phaseProgressBar" class="bar"></div></div>
        <div class="muted">Votes per participant: <span id="voteLimit">3</span></div>
        <div class="row">
          <button id="adjustTimers" class="btn icon-btn" data-label="Customize timers and votes" aria-label="Customize timers and votes" title="Customize timers and votes">‚öôÔ∏è</button>
          <button id="startCreate" class="btn icon-btn" data-label="Start create phase" aria-label="Start create phase" title="Start create phase">üìù</button>
          <button id="startVote" class="btn icon-btn" data-label="Start voting" aria-label="Start voting" title="Start voting">üó≥Ô∏è</button>
          <button id="pausePhase" class="btn icon-btn" data-label="Pause timer" aria-label="Pause timer" title="Pause timer">‚è∏Ô∏è</button>
          <button id="resumePhase" class="btn icon-btn" data-label="Resume timer" aria-label="Resume timer" title="Resume timer">‚ñ∂Ô∏è</button>
          <button id="addMin" class="btn icon-btn" data-label="Add one minute" aria-label="Add one minute" title="Add one minute">‚ûï</button>
          <button id="endPhase" class="btn icon-btn" data-label="End phase" aria-label="End phase" title="End phase">‚èπÔ∏è</button>
        </div>
      </div>
      <div class="cols">
        <div class="col"><h2>To Discuss</h2><div id="todo" class="list"></div></div>
        <div class="col"><h2>Discussing</h2><div id="doing" class="list"></div></div>
        <div class="col"><h2>Done</h2><div id="done" class="list"></div></div>
      </div>
      <div style="padding:12px; border-top:1px solid var(--line);" class="muted">
        <div style="margin-bottom:6px;">Tip: Drag cards between columns to move them.</div>
        <div>Only admins can move/delete topics. Save the admin token provided when creating the meeting.</div>
        <div style="margin-top:8px;">
          Share this link with participants:
          <div class="row" style="margin-top:6px;">
            <input id="shareLink" type="text" readonly style="flex:1;" />
            <button id="copyLink" class="btn">Copy</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const meetingId = location.pathname.split('/').pop().toUpperCase();
      document.getElementById('code').textContent = meetingId;
      const socket = io();
      const tokenInput = document.getElementById('token');
      const saved = localStorage.getItem(`adminToken:${meetingId}`);
      if (saved) tokenInput.value = saved;
      document.getElementById('saveToken').onclick = () => {
        localStorage.setItem(`adminToken:${meetingId}`, tokenInput.value.trim());
        toast('Saved admin token for this device.', 'success');
      };

      socket.emit('join', { meetingId, role: 'admin', adminToken: tokenInput.value.trim() || null });

      // Share link setup
      const shareLinkEl = document.getElementById('shareLink');
      const shareUrl = `${location.origin}/join/${meetingId}`;
      shareLinkEl.value = shareUrl;
      document.getElementById('copyLink').onclick = async () => {
        try { await navigator.clipboard.writeText(shareUrl); toast('Link copied', 'success'); }
        catch { shareLinkEl.select(); document.execCommand('copy'); toast('Link copied', 'success'); }
      };

      const cols = { todo: document.getElementById('todo'), doing: document.getElementById('doing'), done: document.getElementById('done') };
      // Enable drag-and-drop between columns
      for (const [colName, listEl] of Object.entries(cols)){
        listEl.addEventListener('dragover', (e) => { e.preventDefault(); listEl.classList.add('drop-target'); });
        listEl.addEventListener('dragleave', () => listEl.classList.remove('drop-target'));
        listEl.addEventListener('drop', (e) => {
          e.preventDefault(); listEl.classList.remove('drop-target');
          const topicId = e.dataTransfer && e.dataTransfer.getData('text/plain');
          if (topicId) move(topicId, colName);
          if (colName === 'doing' && topicId) {
            if (currentPhase !== 'discuss') { showStartDiscussPrompt(topicId); toast('Moved to Discussing ‚Äî press D to start timer', 'info', 3500); }
          }
        });
      }
      function el({ tag='div', text, className }){ const e = document.createElement(tag); if(text) e.textContent=text; if(className) e.className=className; return e; }
      function move(topicId, column){ const adminToken = tokenInput.value.trim(); socket.emit('move_topic', { meetingId, topicId, column, adminToken }); }
      function startDiscuss(topicId){ const adminToken = tokenInput.value.trim(); const mins = (durations && durations.discuss) ? Number(durations.discuss) : undefined; socket.emit('start_phase', { meetingId, adminToken, phase:'discuss', topicId, minutes: mins }); }
      function del(topicId){ const adminToken = tokenInput.value.trim(); if(!confirm('Delete topic?')) return; socket.emit('delete_topic', { meetingId, topicId, adminToken }); }

      // Phase controls
      const phaseLabel = document.getElementById('phaseLabel');
      const phaseTime = document.getElementById('phaseTime');
      let durations = { create: 5, voting: 3, discuss: 5 };
      let voteLimit = 3;
      const voteLimitEl = document.getElementById('voteLimit');
      function updateVoteLimitUI(){
        if (voteLimitEl) voteLimitEl.textContent = voteLimit;
        const allowance = document.getElementById('adminVoteAllowance');
        if (allowance) allowance.textContent = voteLimit === 1 ? '1 vote' : `${voteLimit} votes`;
      }
      // Adjust timers modal
      const adjustBtn = document.getElementById('adjustTimers');
      adjustBtn.onclick = () => { openTimersModal(); };
      document.getElementById('startCreate').onclick = () => {
        const adminToken = tokenInput.value.trim(); const mins = durations && durations.create ? Number(durations.create) : undefined;
        socket.emit('start_phase', { meetingId, adminToken, phase:'create', minutes: mins });
      };
      document.getElementById('startVote').onclick = () => {
        const adminToken = tokenInput.value.trim(); const mins = durations && durations.voting ? Number(durations.voting) : undefined;
        socket.emit('start_phase', { meetingId, adminToken, phase:'voting', minutes: mins });
      };
      document.getElementById('addMin').onclick = () => {
        const adminToken = tokenInput.value.trim(); socket.emit('add_minute', { meetingId, adminToken });
      };
      document.getElementById('endPhase').onclick = () => {
        const adminToken = tokenInput.value.trim(); socket.emit('end_phase', { meetingId, adminToken });
      };
      document.getElementById('pausePhase').onclick = () => {
        const adminToken = tokenInput.value.trim(); socket.emit('pause_phase', { meetingId, adminToken });
      };
      document.getElementById('resumePhase').onclick = () => {
        const adminToken = tokenInput.value.trim(); socket.emit('resume_phase', { meetingId, adminToken });
      };

      let phaseTicker = null; let lastNow = 0; let endsAt = 0; let currentPhase = null; let currentTopicId = null; let topicsIdx = new Map(); let paused = false; let remainingMs = 0;
      const progressBar = document.getElementById('phaseProgressBar');
      function updatePhaseUI(){
        if (!currentPhase){ phaseLabel.textContent = '‚Äî'; phaseTime.textContent = '‚Äî'; return; }
        let label = currentPhase;
        if (currentPhase === 'discuss' && currentTopicId && topicsIdx.get(currentTopicId)){
          label = `Discussing: ${topicsIdx.get(currentTopicId).title}`;
        } else if (currentPhase === 'create') label = 'Creating topics';
        else if (currentPhase === 'voting') label = 'Voting';
        if (paused) label += ' (Paused)';
        phaseLabel.textContent = label;
        const now = Date.now();
        const base = paused ? Math.max(0, Math.floor((remainingMs)/1000)) : Math.max(0, Math.floor((endsAt - now)/1000));
        const rem = base;
        const m = Math.floor(rem/60), s = rem%60;
        phaseTime.textContent = `${m}:${String(s).padStart(2,'0')}`;
        const totalMin = (durations && durations[currentPhase]) ? Number(durations[currentPhase]) : null;
        if (totalMin && totalMin > 0){
          const pct = Math.max(0, Math.min(100, Math.round((1 - (rem / (totalMin*60))) * 100)));
          progressBar.style.width = `${pct}%`;
        } else { progressBar.style.width = '0%'; }
      }
      function startTicker(){ if (phaseTicker) clearInterval(phaseTicker); phaseTicker = setInterval(updatePhaseUI, 500); }

      // Phase expired prompt
      const phasePrompt = document.getElementById('phasePrompt');
      const promptText = document.getElementById('promptText');
      const promptAddMinResume = document.getElementById('promptAddMinResume');
      const promptAdvance = document.getElementById('promptAdvance');
      const promptDismiss = document.getElementById('promptDismiss');
      function hidePrompt(){ phasePrompt.style.display = 'none'; }
      function showPrompt(text){ promptText.textContent = text; phasePrompt.style.display = 'block'; }
      promptDismiss.onclick = hidePrompt;
      promptAddMinResume.onclick = () => { const adminToken = tokenInput.value.trim(); socket.emit('add_minute', { meetingId, adminToken }); socket.emit('resume_phase', { meetingId, adminToken }); hidePrompt(); };
      promptAdvance.onclick = () => {
        const adminToken = tokenInput.value.trim();
        if (currentPhase === 'create') { socket.emit('start_phase', { meetingId, adminToken, phase:'voting' }); }
        else if (currentPhase === 'voting') { toast('Drag a topic to Discussing, then click Start Timer.', 'info'); }
        else if (currentPhase === 'discuss') {
          if (currentTopicId) { socket.emit('move_topic', { meetingId, topicId: currentTopicId, column:'done', adminToken }); }
          socket.emit('end_phase', { meetingId, adminToken });
        }
        hidePrompt();
      };
      const defaultAdvanceHandler = promptAdvance.onclick;
      function showStartDiscussPrompt(topicId){
        promptText.textContent = 'Start the discussion timer now?';
        phasePrompt.style.display = 'block';
        promptAddMinResume.style.display = 'none';
        const oldText = promptAdvance.textContent;
        promptAdvance.textContent = 'Start Timer';
        promptAdvance.onclick = () => { startDiscuss(topicId); promptAdvance.onclick = defaultAdvanceHandler; promptAdvance.textContent = oldText; promptAddMinResume.style.display = ''; hidePrompt(); };
        promptDismiss.onclick = () => { promptAdvance.onclick = defaultAdvanceHandler; promptAdvance.textContent = oldText; promptAddMinResume.style.display = ''; hidePrompt(); };
      }

      socket.on('state', (state) => {
        // Durations & vote limit
        if (state.durations){ durations = state.durations; }
        if (state.config && typeof state.config.maxVotesPerParticipant === 'number') {
          voteLimit = state.config.maxVotesPerParticipant;
        }
        preloadTimersModal(durations);
        updateVoteLimitUI();
        // Phase
        currentPhase = state.phase || null; endsAt = state.phaseEndsAt || 0; lastNow = state.now || Date.now(); currentTopicId = state.currentTopicId || null; paused = !!state.phasePaused; remainingMs = state.phaseRemainingMs || 0;
        updatePhaseUI(); startTicker();
        if (!currentPhase || (!paused && endsAt && endsAt > Date.now())) hidePrompt();
        for (const k of Object.keys(cols)) cols[k].innerHTML = '';
        const byCol = { todo: [], doing: [], done: [] };
        topicsIdx = new Map();
        for (const t of state.topics){ byCol[t.column||'todo'].push(t); topicsIdx.set(t.id, t); }
        const sort = arr => arr.sort((a,b)=> b.votes - a.votes || a.createdAt - b.createdAt);
        for (const col of ['todo','doing','done']){
          if (byCol[col].length === 0) {
            const hint = document.createElement('div');
            hint.className = 'muted';
            hint.style.margin = '12px 0';
            hint.textContent = col === 'todo' ? 'No topics yet. Start the Create phase so participants can add topics.'
                              : col === 'doing' ? 'Drag a topic here to start discussing it.'
                              : 'Completed discussions appear here.';
            cols[col].appendChild(hint);
          }
          for (const t of sort(byCol[col])){
            const c = el({ className: 'card' });
            // Make cards draggable and focusable for drag-and-drop moves
            c.setAttribute('draggable', 'true');
            c.setAttribute('tabindex', '0');
            c.addEventListener('dragstart', (e) => { if(e.dataTransfer){ e.dataTransfer.setData('text/plain', t.id); } });
            const left = el({ className:'left' });
            left.appendChild(el({ text: t.title }));
            left.appendChild(el({ className:'votes', text: `‚ñ≤ ${t.votes || 0}` }));
            const bar = el({ className:'btnbar' });
            if (t.column === 'doing') bar.appendChild(Object.assign(el({ tag:'button', className:'btn primary', text:'Start Timer'}), { onclick: () => startDiscuss(t.id) }));
            bar.appendChild(Object.assign(el({ tag:'button', className:'btn danger', text:'Delete'}), { onclick: () => del(t.id) }));
            c.appendChild(left); c.appendChild(bar);
            cols[col].appendChild(c);
          }
        }
      });

      // Server signals when a phase timer expires
      socket.on('phase_expired', ({ phase }) => {
        if (phase === 'create') showPrompt('Create phase ended. Add 1 minute or go to Voting?');
        else if (phase === 'voting') showPrompt('Voting ended. Add 1 minute or pick a topic to discuss.');
        else if (phase === 'discuss') showPrompt('Continue discussion? Add 1 minute or complete the topic and pick another.');
      });

      // ----- Timers modal -----
      const modalHtml = `
        <div id="timersOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:9999;">
          <div style="background:#0f1630;border:1px solid #23305f;border-radius:12px;max-width:520px;width:92%;padding:16px;">
            <h3 style="margin-top:0;margin-bottom:8px;">Adjust Phase Timers</h3>
            <div class="muted">Set timer lengths in minutes. Applies immediately.</div>
            <div class="row" style="margin-top:12px;">
              <label style="min-width:110px;">Create Topics</label>
              <input id="mDurCreate" type="number" min="1" max="60" style="width:100px;" />
            </div>
            <div class="row" style="margin-top:8px;">
              <label style="min-width:110px;">Voting</label>
              <input id="mDurVote" type="number" min="1" max="60" style="width:100px;" />
            </div>
            <div class="row" style="margin-top:8px;">
              <label style="min-width:110px;">Discuss</label>
              <input id="mDurDiscuss" type="number" min="1" max="60" style="width:100px;" />
            </div>
            <div class="row" style="margin-top:8px;">
              <label style="min-width:110px;">Votes per person</label>
              <input id="mVoteLimit" type="number" min="1" max="10" style="width:100px;" />
            </div>
            <div class="muted" style="margin-top:6px;">Changes apply immediately for everyone.</div>
            <div class="row" style="margin-top:12px;justify-content:flex-end;">
              <button id="mCancel" class="btn">Cancel</button>
              <button id="mSave" class="btn primary">Save</button>
            </div>
          </div>
        </div>`;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      const overlay = document.getElementById('timersOverlay');
      function preloadTimersModal(d){
        if (!d) d = durations;
        const c=document.getElementById('mDurCreate'); const v=document.getElementById('mDurVote'); const s=document.getElementById('mDurDiscuss'); const mv=document.getElementById('mVoteLimit');
        if (c && d.create != null) c.value = d.create;
        if (v && d.voting != null) v.value = d.voting;
        if (s && d.discuss != null) s.value = d.discuss;
        if (mv) mv.value = voteLimit;
      }
      function openTimersModal(){ overlay.style.display='flex'; preloadTimersModal(durations); }
      function closeTimersModal(){ overlay.style.display='none'; }
      overlay.addEventListener('click', (e)=>{ if(e.target===overlay) closeTimersModal(); });
      document.getElementById('mCancel').onclick = closeTimersModal;
      document.getElementById('mSave').onclick = () => {
        const adminToken = tokenInput.value.trim();
        const c = Number(document.getElementById('mDurCreate').value)||durations.create;
        const v = Number(document.getElementById('mDurVote').value)||durations.voting;
        const s = Number(document.getElementById('mDurDiscuss').value)||durations.discuss;
        socket.emit('set_durations', { meetingId, adminToken, create: c, voting: v, discuss: s });
        const votesVal = Number(document.getElementById('mVoteLimit').value);
        if (Number.isFinite(votesVal) && votesVal >= 1 && votesVal !== voteLimit){
          socket.emit('set_vote_limit', { meetingId, adminToken, maxVotes: votesVal });
        }
        closeTimersModal();
      };

      // ----- Help modal -----
      const helpHtml = `
        <div id="helpOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:9999;">
          <div style="background:#0f1630;border:1px solid #23305f;border-radius:12px;max-width:640px;width:92%;padding:16px;">
            <h3 style="margin-top:0;margin-bottom:8px;">Lean Coffee ‚Äî How it works</h3>
            <ul style="line-height:1.5; margin-left: 18px;">
              <li>Everyone proposes topics during the <strong>Create</strong> phase.</li>
              <li>Each participant gets <strong id="adminVoteAllowance">3 votes</strong> in the <strong>Voting</strong> phase. Adjust this under Adjust timers.</li>
              <li>Discuss topics in order of votes. Each discussion is <strong>time‚Äëboxed</strong>.</li>
              <li>At the end of a timer, choose to <strong>continue</strong> or <strong>move on</strong> to the next topic.</li>
              <li>Columns: <strong>To Discuss</strong>, <strong>Discussing</strong>, <strong>Done</strong>. Only admins move topics.</li>
            </ul>
            <div class="row" style="justify-content:flex-end; margin-top: 12px;">
              <button id="hClose" class="btn primary">Got it</button>
            </div>
          </div>
        </div>`;
      document.body.insertAdjacentHTML('beforeend', helpHtml);
      const helpOverlay = document.getElementById('helpOverlay');
      updateVoteLimitUI();
      document.getElementById('helpBtn').onclick = () => { helpOverlay.style.display = 'flex'; };
      document.getElementById('hClose').onclick = () => { helpOverlay.style.display = 'none'; };
      helpOverlay.addEventListener('click', (e)=>{ if(e.target===helpOverlay) helpOverlay.style.display='none'; });

      // First-time onboarding: show help once and hint shortcuts
      try {
        const key = 'onboarded_admin_v1';
        if (!localStorage.getItem(key)){
          helpOverlay.style.display = 'flex';
          localStorage.setItem(key, '1');
          toast('Shortcuts: P pause/resume, + add minute, V voting, D discuss', 'info', 5000);
        }
      } catch {}

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
        if (tag === 'input' || tag === 'textarea' || e.isComposing) return;
        if (e.key === 'p' || e.key === 'P'){
          const adminToken = tokenInput.value.trim();
          if (paused) socket.emit('resume_phase', { meetingId, adminToken }); else socket.emit('pause_phase', { meetingId, adminToken });
        } else if (e.key === '+' || e.key === '='){
          const adminToken = tokenInput.value.trim(); socket.emit('add_minute', { meetingId, adminToken }); toast('+1 minute', 'success');
        } else if (e.key === 'v' || e.key === 'V'){
          const adminToken = tokenInput.value.trim(); socket.emit('start_phase', { meetingId, adminToken, phase: 'voting', minutes: durations && durations.voting ? Number(durations.voting) : undefined });
        } else if (e.key === 'd' || e.key === 'D'){
          if (currentTopicId) { startDiscuss(currentTopicId); }
          else {
            const doing = Array.from(topicsIdx.values()).filter(t => t.column === 'doing');
            if (doing.length === 1) startDiscuss(doing[0].id);
            else toast('Drag a topic to Discussing, then press D to start.', 'info');
          }
        }
      });
    </script>
  </body>
  </html>

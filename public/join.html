<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Join Lean Coffee</title>
    <style>
      :root { --bg: #0b1020; --panel: #0f1630; --line: #23305f; --text: #f2f5ff; --muted:#a3b0d4; --accent: #60a5fa; }
      body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--text); }
      header { padding: 12px 16px; border-bottom: 1px solid var(--line); display:flex; align-items:center; justify-content:space-between; gap: 12px; }
      .container { max-width: 800px; margin: 0 auto; padding: 16px; }
      .card { background: var(--panel); border: 1px solid var(--line); border-radius: 12px; padding: 16px; margin: 16px 0; }
      .row { display:flex; gap: 8px; align-items:center; }
      input[type="text"] { width: 100%; font-size: 16px; padding: 10px 12px; border-radius: 8px; border: 1px solid #33407a; background: #0f1630; color: #fff; }
      button { font-size: 16px; padding: 10px 12px; border-radius: 8px; border: 1px solid #3759a3; background:#13204a; color:#fff; cursor:pointer; }
      .list .item { display:flex; justify-content:space-between; align-items:flex-start; gap: 12px; background: #111a3b; border:1px solid #2b3a79; border-radius:10px; padding:10px 12px; margin: 10px 0; }
      .list .item.has-your-vote { border-color:#60a5fa; box-shadow:0 0 0 1px #60a5fa33; }
      /* Status highlighting for topic columns */
      .list .item.status-todo { border-left: 4px solid #60a5fa; }
      .list .item.status-doing { border-left: 4px solid #f59e0b; background: #1f1a0e; }
      .list .item.status-done { border-left: 4px solid #10b981; opacity: 0.95; }
      .status-pill { display:inline-block; font-size: 12px; padding: 2px 8px; border-radius: 999px; border: 1px solid #33407a; color: #a3b0d4; }
      .status-pill.todo { border-color:#2563eb; color:#93c5fd; }
      .status-pill.doing { border-color:#92400e; color:#fbbf24; }
      .status-pill.done { border-color:#065f46; color:#6ee7b7; }
      .votes { color: var(--accent); font-weight: 600; }
      .vote-info { display:flex; flex-direction:column; align-items:flex-end; gap:4px; }
      .vote-controls { display:flex; flex-direction:column; align-items:center; gap:4px; }
      .vote-arrow { font-size:18px; line-height:1; padding:4px 8px; border-radius:8px; border:1px solid #3759a3; background:#13204a; color:#93c5fd; cursor:pointer; transition:background 0.2s ease, border-color 0.2s ease; }
      .vote-arrow.up.selected { background:#1d4ed8; border-color:#1d4ed8; color:#fff; box-shadow:0 0 0 1px #93c5fd44; }
      .vote-arrow:disabled { opacity:0.4; cursor:not-allowed; }
      .vote-arrow:not(:disabled):hover { background:#1d2c5c; }
      .vote-arrow.up.selected:not(:disabled):hover { background:#1e40af; }
      .vote-total { font-weight:600; color:var(--accent); min-width:24px; text-align:right; }
      .your-votes { font-size:12px; color:#bfdbfe; background:#10224f; border:1px solid #1d4ed8; border-radius:999px; padding:2px 8px; }
      .muted { color: var(--muted); font-size: 14px; }
      .progress { position: relative; width: 240px; height: 8px; background: #0f1630; border:1px solid #23305f; border-radius: 999px; overflow: hidden; }
      .progress .bar { height: 100%; width: 0%; background: linear-gradient(90deg, #2563eb, #60a5fa); transition: width 0.3s ease; }
      .phase-banner { margin: 12px 0; padding: 10px 12px; border-radius: 10px; font-weight: 600; }
      .phase-create { background: #0b3d13; border: 1px solid #14532d; color: #bbf7d0; }
      .phase-voting { background: #0b2a4d; border: 1px solid #1e3a8a; color: #bfdbfe; }
      .phase-discuss { background: #4d2a0b; border: 1px solid #92400e; color: #fde68a; }
    </style>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/ui.js"></script>
  </head>
  <body>
    <header>
      <div>Join — <span id="code"></span></div>
      <div class="row" style="gap:8px; align-items:center;">
        <div class="muted">Phase: <span id="phaseLabel">—</span> • Time: <span id="phaseTime">—</span> • Votes remaining: <span id="remaining">0</span></div>
        <button id="helpBtn" title="Lean Coffee rules" style="font-size:14px; padding:6px 10px;">?</button>
      </div>
      <div class="progress" title="Phase progress" style="margin: 8px 16px 0 16px;"><div id="phaseProgressBar" class="bar"></div></div>
    </header>
    <div class="container">
      <div id="phaseBanner" class="phase-banner" style="display:none;">—</div>
      <div id="createCard" class="card">
        <div class="row">
          <input id="topicInput" type="text" placeholder="Propose a topic" maxlength="200" />
          <button id="submitBtn">Submit</button>
        </div>
        <div class="muted" id="submitHelp" style="margin-top:6px;">Max 200 characters. Everyone can see your topic title.</div>
      </div>
      <div class="card">
        <h3>Topics</h3>
        <div id="list" class="list"></div>
      </div>
    </div>

    <script>
      const meetingId = location.pathname.split('/').pop().toUpperCase();
      document.getElementById('code').textContent = meetingId;
      const socket = io();
      // Server assigns a per-meeting participant id via cookie; we still pass a fallback id
      let participantId = Math.random().toString(36).slice(2,10);
      socket.emit('join', { meetingId, role: 'participant', id: participantId });

      const topicInput = document.getElementById('topicInput');
      const submitBtn = document.getElementById('submitBtn');
      const createCard = document.getElementById('createCard');
      const phaseBanner = document.getElementById('phaseBanner');
      function submitTopic(){
        const title = topicInput.value.trim(); if(!title) return;
        if (currentPhase !== 'create') { toast('Topic submission opens during Create phase', 'info'); return; }
        socket.emit('submit_topic', { meetingId, title, authorId: participantId });
        topicInput.value = '';
      }
      submitBtn.onclick = submitTopic;
      topicInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); submitTopic(); }
      });

      let maxVotes = 3; let voted = new Map(); let latestState = null;
      function adjustLocalVotes(topicId, delta){
        if (!topicId || !delta) return;
        const current = Number(voted.get(topicId)) || 0;
        const next = Math.max(0, current + delta);
        if (next === 0) voted.delete(topicId); else voted.set(topicId, next);
      }
      function rerender(){ if (latestState) render(latestState); else refreshRemaining(); }
      const votesUsed = () => {
        let total = 0;
        voted.forEach((count) => { const n = Number(count) || 0; if (n > 0) total += n; });
        return total;
      };
      function updateVoteAllowance(){
        const el = document.getElementById('voteAllowance');
        if (el) {
          const safe = Number.isFinite(maxVotes) ? maxVotes : 0;
          el.textContent = safe === 1 ? '1 vote' : `${safe} votes`;
        }
      }
      let currentPhase = null; let endsAt = 0; let phaseTicker = null; let paused=false; let remainingMs=0; let durations = { create:5, voting:3, discuss:5 };
      const progressBar = document.getElementById('phaseProgressBar');
      function refreshRemaining(){
        const remaining = Math.max(0, maxVotes - votesUsed());
        document.getElementById('remaining').textContent = remaining;
        updateVoteAllowance();
      }
      function updatePhaseUI(){
        const phaseLabel = document.getElementById('phaseLabel'); const phaseTime = document.getElementById('phaseTime');
        let label = '—'; if (currentPhase === 'create') label = 'Creating'; else if (currentPhase === 'voting') label='Voting'; else if (currentPhase === 'discuss') label='Discussing';
        if (paused) label += ' (Paused)';
        phaseLabel.textContent = label;
        const now = Date.now();
        const rem = Math.max(0, Math.floor(((paused ? remainingMs : (endsAt - now)))/1000));
        const m = Math.floor(rem/60), s = rem%60;
        phaseTime.textContent = `${m}:${String(s).padStart(2,'0')}`;
        const totalMin = (durations && durations[currentPhase]) ? Number(durations[currentPhase]) : null;
        if (totalMin && totalMin > 0){
          const pct = Math.max(0, Math.min(100, Math.round((1 - (rem / (totalMin*60))) * 100)));
          progressBar.style.width = `${pct}%`;
        } else { progressBar.style.width = '0%'; }
        const submitHelp = document.getElementById('submitHelp');
        const allowed = currentPhase === 'create';
        if (createCard) createCard.style.display = allowed ? '' : 'none';
        if (submitHelp) submitHelp.textContent = 'Max 200 characters. Everyone can see your topic title.';
        // Phase banner
        if (!currentPhase) {
          phaseBanner.style.display = 'none';
        } else {
          phaseBanner.style.display = '';
          const plainLabel = (currentPhase === 'create') ? 'Create' : (currentPhase === 'voting' ? 'Voting' : 'Discuss');
          phaseBanner.textContent = `Current phase: ${plainLabel}${paused ? ' (Paused)' : ''}`;
          phaseBanner.className = `phase-banner ${currentPhase === 'create' ? 'phase-create' : currentPhase === 'voting' ? 'phase-voting' : 'phase-discuss'}`;
        }
      }
      function startTicker(){ if (phaseTicker) clearInterval(phaseTicker); phaseTicker = setInterval(updatePhaseUI, 500); }

      function render(state){
        const configuredMax = state?.config?.maxVotesPerParticipant;
        if (typeof configuredMax === 'number' && Number.isFinite(configuredMax)) {
          maxVotes = configuredMax;
        }
        if (!Number.isFinite(maxVotes) || maxVotes < 1) maxVotes = 1;
        // Phase
        if (state.durations) durations = state.durations;
        currentPhase = state.phase || null; endsAt = state.phaseEndsAt || 0; paused = !!state.phasePaused; remainingMs = state.phaseRemainingMs || 0; updatePhaseUI(); startTicker();
        const list = document.getElementById('list'); list.innerHTML = '';
        const items = state.topics.slice().sort((a,b)=> b.votes - a.votes || a.createdAt - b.createdAt);
        if (items.length === 0){
          const empty = document.createElement('div');
          empty.className = 'muted';
          empty.style.marginTop = '8px';
          empty.textContent = currentPhase === 'create' ? 'Be the first to propose a topic!' : 'No topics yet. Topics will appear once the Create phase starts.';
          list.appendChild(empty);
        }
        for (const t of items){
          const div = document.createElement('div'); div.className = 'item';
          const col = t.column || 'todo';
          div.classList.add(`status-${col}`);
          const yourCount = Number(voted.get(t.id)) || 0;
          const hasYourVote = yourCount > 0;
          if (hasYourVote) div.classList.add('has-your-vote');
          const left = document.createElement('div'); left.textContent = t.title; left.style.flex = '1'; div.appendChild(left);
          // Add a small status pill under the title
          const statusWrap = document.createElement('div'); statusWrap.style.marginTop = '4px';
          const pill = document.createElement('span');
          pill.className = `status-pill ${col}`;
          pill.textContent = col === 'doing' ? 'Discussing' : (col === 'done' ? 'Done' : 'To Discuss');
          statusWrap.appendChild(pill);
          left.appendChild(statusWrap);
          const right = document.createElement('div'); right.className = 'vote-info';
          const controls = document.createElement('div'); controls.className = 'vote-controls';
          const upBtn = document.createElement('button'); upBtn.type = 'button'; upBtn.className = 'vote-arrow up'; upBtn.textContent = '▲';
          if (hasYourVote) upBtn.classList.add('selected');
          const canAddVote = currentPhase === 'voting' && votesUsed() < maxVotes;
          upBtn.disabled = !canAddVote;
          if (!canAddVote) {
            upBtn.title = currentPhase !== 'voting' ? 'Voting is closed' : 'No votes remaining';
          } else {
            upBtn.title = 'Add a vote to this topic';
          }
          upBtn.onclick = () => {
            if (currentPhase !== 'voting') return;
            if (votesUsed() >= maxVotes) { toast('No votes remaining', 'error'); return; }
            adjustLocalVotes(t.id, 1);
            rerender();
            socket.emit('vote', { meetingId, participantId, topicId: t.id });
          };
          const votes = document.createElement('span'); votes.className = 'vote-total'; votes.textContent = t.votes || 0;
          const downBtn = document.createElement('button'); downBtn.type = 'button'; downBtn.className = 'vote-arrow down'; downBtn.textContent = '▼';
          const canRemoveVote = yourCount > 0;
          downBtn.disabled = !canRemoveVote;
          downBtn.title = canRemoveVote ? 'Remove one of your votes from this topic' : 'No votes from you to remove';
          downBtn.onclick = () => {
            if (!voted.get(t.id)) return;
            adjustLocalVotes(t.id, -1);
            rerender();
            socket.emit('unvote', { meetingId, participantId, topicId: t.id });
          };
          controls.appendChild(upBtn);
          controls.appendChild(votes);
          controls.appendChild(downBtn);
          right.appendChild(controls);
          if (hasYourVote){
            const chip = document.createElement('span');
            chip.className = 'your-votes';
            chip.textContent = yourCount === 1 ? 'You used 1 vote' : `You used ${yourCount} votes`;
            right.appendChild(chip);
          }
          div.appendChild(right);
          list.appendChild(div);
        }
        refreshRemaining();
      }

      socket.on('state', (state) => { latestState = state; render(state); });
      socket.on('your_votes', ({ topicCounts, max }) => {
        voted = new Map();
        if (topicCounts && typeof topicCounts === 'object') {
          for (const [topicId, count] of Object.entries(topicCounts)) {
            const n = Number(count) || 0;
            if (n > 0) voted.set(topicId, n);
          }
        }
        if (typeof max === 'number' && Number.isFinite(max)) maxVotes = max;
        if (latestState) render(latestState); else refreshRemaining();
      });
      // Soft update when a new topic is added so everyone stays in sync
      socket.on('topic_added', () => { if (latestState) render(latestState); });

      // ----- Help modal -----
      const helpHtml = `
        <div id="helpOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:9999;">
          <div style="background:#0f1630;border:1px solid #23305f;border-radius:12px;max-width:640px;width:92%;padding:16px;">
            <h3 style="margin-top:0;margin-bottom:8px;">Lean Coffee — How it works</h3>
            <ul style="line-height:1.5; margin-left: 18px;">
              <li>Propose topics during the <strong>Create</strong> phase.</li>
              <li>You get <strong id="voteAllowance">3 votes</strong> to prioritize topics during <strong>Voting</strong>. Facilitator may adjust this.</li>
              <li>We discuss topics by vote order with <strong>time‑boxed</strong> discussions.</li>
              <li>At a timer end, the facilitator may <strong>continue</strong> or move on.</li>
              <li>Columns: <strong>To Discuss</strong>, <strong>Discussing</strong>, <strong>Done</strong>. Only the facilitator moves topics.</li>
            </ul>
            <div class="row" style="justify-content:flex-end; margin-top: 12px;">
              <button id="hClose" style="font-size:14px; padding:6px 10px;">Got it</button>
            </div>
          </div>
        </div>`;
      document.body.insertAdjacentHTML('beforeend', helpHtml);
      const helpOverlay = document.getElementById('helpOverlay');
      updateVoteAllowance();
      document.getElementById('helpBtn').onclick = () => { helpOverlay.style.display = 'flex'; };
      document.getElementById('hClose').onclick = () => { helpOverlay.style.display = 'none'; };
      helpOverlay.addEventListener('click', (e)=>{ if(e.target===helpOverlay) helpOverlay.style.display='none'; });

      // First-time onboarding for participants
      try {
        const key = 'onboarded_join_v1';
        if (!localStorage.getItem(key)){
          helpOverlay.style.display = 'flex';
          localStorage.setItem(key, '1');
        }
      } catch {}
    </script>
  </body>
  </html>

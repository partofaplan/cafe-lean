<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Join Lean Coffee</title>
    <style>
      :root { --bg: #0b1020; --panel: #0f1630; --line: #23305f; --text: #f2f5ff; --muted:#a3b0d4; --accent: #60a5fa; }
      body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--text); }
      header { padding: 12px 16px; border-bottom: 1px solid var(--line); display:flex; align-items:center; justify-content:space-between; gap: 12px; }
      .container { max-width: 800px; margin: 0 auto; padding: 16px; }
      .card { background: var(--panel); border: 1px solid var(--line); border-radius: 12px; padding: 16px; margin: 16px 0; }
      .row { display:flex; gap: 8px; align-items:center; }
      input[type="text"] { width: 100%; font-size: 16px; padding: 10px 12px; border-radius: 8px; border: 1px solid #33407a; background: #0f1630; color: #fff; }
      button { font-size: 16px; padding: 10px 12px; border-radius: 8px; border: 1px solid #3759a3; background:#13204a; color:#fff; cursor:pointer; }
      .list .item { display:flex; justify-content:space-between; align-items:center; background: #111a3b; border:1px solid #2b3a79; border-radius:10px; padding:10px 12px; margin: 10px 0; }
      .votes { color: var(--accent); font-weight: 600; }
      .muted { color: var(--muted); font-size: 14px; }
    </style>
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body>
    <header>
      <div>Join — <span id="code"></span></div>
      <div class="row" style="gap:8px; align-items:center;">
        <div class="muted">Phase: <span id="phaseLabel">—</span> • Time: <span id="phaseTime">—</span> • Votes remaining: <span id="remaining">0</span></div>
        <button id="helpBtn" title="Lean Coffee rules" style="font-size:14px; padding:6px 10px;">?</button>
      </div>
    </header>
    <div class="container">
      <div class="card">
        <div class="row">
          <input id="topicInput" type="text" placeholder="Propose a topic" maxlength="200" />
          <button id="submitBtn">Submit</button>
        </div>
        <div class="muted" id="submitHelp" style="margin-top:6px;">Max 200 characters. Everyone can see your topic title.</div>
      </div>
      <div class="card">
        <h3>Topics</h3>
        <div id="list" class="list"></div>
      </div>
    </div>

    <script>
      const meetingId = location.pathname.split('/').pop().toUpperCase();
      document.getElementById('code').textContent = meetingId;
      const socket = io();
      // Server assigns a per-meeting participant id via cookie; we still pass a fallback id
      let participantId = Math.random().toString(36).slice(2,10);
      socket.emit('join', { meetingId, role: 'participant', id: participantId });

      const topicInput = document.getElementById('topicInput');
      document.getElementById('submitBtn').onclick = () => {
        const title = topicInput.value.trim(); if(!title) return;
        socket.emit('submit_topic', { meetingId, title, authorId: participantId });
        topicInput.value = '';
      };

      let maxVotes = 3; let voted = new Set(); let latestState = null;
      let currentPhase = null; let endsAt = 0; let phaseTicker = null; let paused=false; let remainingMs=0;
      function refreshRemaining(){ document.getElementById('remaining').textContent = Math.max(0, maxVotes - voted.size); }
      function updatePhaseUI(){
        const phaseLabel = document.getElementById('phaseLabel'); const phaseTime = document.getElementById('phaseTime');
        let label = '—'; if (currentPhase === 'create') label = 'Creating'; else if (currentPhase === 'voting') label='Voting'; else if (currentPhase === 'discuss') label='Discussing';
        if (paused) label += ' (Paused)';
        phaseLabel.textContent = label;
        const now = Date.now();
        const rem = Math.max(0, Math.floor(((paused ? remainingMs : (endsAt - now)))/1000));
        const m = Math.floor(rem/60), s = rem%60;
        phaseTime.textContent = `${m}:${String(s).padStart(2,'0')}`;
        const submitBtn = document.getElementById('submitBtn');
        const submitHelp = document.getElementById('submitHelp');
        const allowed = currentPhase === 'create';
        submitBtn.disabled = !allowed;
        submitBtn.textContent = allowed ? 'Submit' : 'Submit (Create phase only)';
        submitHelp.textContent = allowed ? 'Max 200 characters. Everyone can see your topic title.' : 'Topic submission opens during the Create phase. Please wait for the facilitator to start it.';
      }
      function startTicker(){ if (phaseTicker) clearInterval(phaseTicker); phaseTicker = setInterval(updatePhaseUI, 500); }

      function render(state){
        maxVotes = state?.config?.MAX_VOTES_PER_PARTICIPANT ?? 3;
        // Phase
        currentPhase = state.phase || null; endsAt = state.phaseEndsAt || 0; paused = !!state.phasePaused; remainingMs = state.phaseRemainingMs || 0; updatePhaseUI(); startTicker();
        const list = document.getElementById('list'); list.innerHTML = '';
        const items = state.topics.slice().sort((a,b)=> b.votes - a.votes || a.createdAt - b.createdAt);
        for (const t of items){
          const div = document.createElement('div'); div.className = 'item';
          const left = document.createElement('div'); left.textContent = t.title; div.appendChild(left);
          const right = document.createElement('div');
          const btn = document.createElement('button');
          const has = voted.has(t.id);
          btn.textContent = has ? 'Unvote' : 'Vote';
          if (!has && (voted.size >= maxVotes || currentPhase !== 'voting')) { btn.disabled = true; }
          btn.onclick = () => {
            if (voted.has(t.id)) {
              socket.emit('unvote', { meetingId, participantId, topicId: t.id });
            } else {
              if (voted.size >= maxVotes) { alert('No votes remaining'); return; }
              if (currentPhase !== 'voting') { alert('Voting is not active'); return; }
              socket.emit('vote', { meetingId, participantId, topicId: t.id });
            }
          };
          right.appendChild(btn);
          const votes = document.createElement('span'); votes.className = 'votes'; votes.textContent = ` ▲ ${t.votes || 0}`;
          right.appendChild(votes);
          div.appendChild(right);
          list.appendChild(div);
        }
        refreshRemaining();
      }

      socket.on('state', (state) => { latestState = state; render(state); });
      socket.on('your_votes', ({ topicIds, max }) => { voted = new Set(topicIds || []); if (typeof max === 'number') maxVotes = max; if (latestState) render(latestState); else refreshRemaining(); });
      // Soft update when a new topic is added so everyone stays in sync
      socket.on('topic_added', () => { if (latestState) render(latestState); });

      // ----- Help modal -----
      const helpHtml = `
        <div id="helpOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:9999;">
          <div style="background:#0f1630;border:1px solid #23305f;border-radius:12px;max-width:640px;width:92%;padding:16px;">
            <h3 style="margin-top:0;margin-bottom:8px;">Lean Coffee — How it works</h3>
            <ul style="line-height:1.5; margin-left: 18px;">
              <li>Propose topics during the <strong>Create</strong> phase.</li>
              <li>You have <strong>3 votes</strong> total to prioritize topics during <strong>Voting</strong>.</li>
              <li>We discuss topics by vote order with <strong>time‑boxed</strong> discussions.</li>
              <li>At a timer end, the facilitator may <strong>continue</strong> or move on.</li>
              <li>Columns: <strong>To Discuss</strong>, <strong>Discussing</strong>, <strong>Done</strong>. Only the facilitator moves topics.</li>
            </ul>
            <div class="row" style="justify-content:flex-end; margin-top: 12px;">
              <button id="hClose" style="font-size:14px; padding:6px 10px;">Got it</button>
            </div>
          </div>
        </div>`;
      document.body.insertAdjacentHTML('beforeend', helpHtml);
      const helpOverlay = document.getElementById('helpOverlay');
      document.getElementById('helpBtn').onclick = () => { helpOverlay.style.display = 'flex'; };
      document.getElementById('hClose').onclick = () => { helpOverlay.style.display = 'none'; };
      helpOverlay.addEventListener('click', (e)=>{ if(e.target===helpOverlay) helpOverlay.style.display='none'; });
    </script>
  </body>
  </html>
